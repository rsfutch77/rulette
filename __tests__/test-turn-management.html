<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turn Management Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
            padding-bottom: 200px; /* Space for fixed bottom bar */
        }
        .main-container { 
            display: flex; 
            gap: 20px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        .test-column {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: calc(100vh - 280px); /* Account for top padding and bottom results bar */
            overflow-y: auto;
        }
        .instructions-column {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
            height: calc(100vh - 280px); /* Account for top padding and bottom results bar */
            overflow-y: auto;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .test-button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer; 
            display: block;
            width: 100%;
            text-align: left;
        }
        .test-button:hover { background: #0056b3; }
        .test-button:disabled { background: #6c757d; cursor: not-allowed; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; }
        
        /* Fixed bottom results bar */
        #test-results { 
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #343a40;
            color: white;
            padding: 15px;
            max-height: 180px;
            overflow-y: auto;
            border-top: 3px solid #007bff;
            z-index: 1000;
        }
        #test-results h4 {
            margin: 0 0 10px 0;
            color: #ffc107;
        }
        #results-content {
            font-size: 12px;
            line-height: 1.4;
        }
        #results-content div {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #495057;
        }
        
        .turn-indicator { 
            background: #e8f5e8; 
            border: 2px solid #28a745; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
            text-align: center; 
        }
        .current-player { font-size: 1.2em; font-weight: bold; color: #155724; }
        .waiting-player { color: #6c757d; font-style: italic; }
        
        .instruction-step {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 12px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        .instruction-step.phase-1 { border-left-color: #007bff; }
        .instruction-step.phase-2 { border-left-color: #28a745; }
        .instruction-step.phase-3 { border-left-color: #ffc107; }
        .instruction-step.phase-4 { border-left-color: #6c757d; }
        
        .step-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }
        .step-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .step-description {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
        }
        .step-expected {
            font-size: 12px;
            color: #28a745;
            font-style: italic;
        }
        
        h1, h2, h3 {
            color: #343a40;
        }
        
        .phase-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 20px 0 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Test Controls Column -->
        <div class="test-column">
            <h1>Turn Management System Test</h1>
            <p>This page tests the Turn Management implementation for the Wheel Spin and Card Draw Logic.</p>
            
            <div class="test-section">
                <h3>Phase 1: Test Setup</h3>
                <button class="test-button" onclick="initializeTest()">1. Initialize Test Session</button>
                <button class="test-button" onclick="showTurnInfo()">2. Show Turn Info</button>
                <button class="test-button" onclick="resetTest()">Reset Test</button>
                <button class="test-button" onclick="runAllTests()">üöÄ Run All Tests</button>
            </div>
            
            <div class="test-section">
                <h3>Phase 2: Turn Order Tests</h3>
                <button class="test-button" onclick="testCurrentPlayerSpin()">3. Test Current Player Spin</button>
                <button class="test-button" onclick="testWrongPlayerSpin()">4. Test Wrong Player Spin (Should Fail)</button>
                <button class="test-button" onclick="testDoubleSpinPrevention()">5. Test Double Spin Prevention</button>
                <button class="test-button" onclick="testTurnAdvancement()">6. Test Turn Advancement</button>
            </div>
            
            <div class="test-section">
                <h3>Phase 3: UI Indicator Tests</h3>
                <button class="test-button" onclick="testUIUpdates()">7. Test UI Turn Indicators</button>
                <button class="test-button" onclick="testWheelButtonState()">8. Test Wheel Button State</button>
            </div>
            
            <div id="turn-management" class="turn-indicator" style="display:none;">
                <div class="current-player">
                    <span id="current-player-name">Player Name</span>'s Turn
                </div>
                <div style="margin: 10px 0;">
                    Turn <span id="current-turn-number">1</span> of 10
                </div>
                <div id="turn-actions">
                    <div id="waiting-message" style="display:none;" class="waiting-player">
                        Waiting for <span id="waiting-player-name">Player</span> to take their turn...
                    </div>
                    <div id="your-turn-message" style="display:none;" class="current-player">
                        It's your turn! Spin the wheel to draw a card.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Instructions Column -->
        <div class="instructions-column">
            <h2>üìã Step-by-Step Testing Guide</h2>
            
            <div class="phase-header">Phase 1: Setup and Initialization</div>
            
            <div class="instruction-step phase-1">
                <div class="step-title">
                    <span class="step-number">1</span>Click "Initialize Test Session" (REQUIRED FIRST)
                </div>
                <div class="step-description">
                    Sets up a mock game session with 3 players and initializes turn order
                </div>
                <div class="step-expected">
                    ‚úÖ Green success messages, turn order displayed, UI becomes visible
                </div>
            </div>
            
            <div class="instruction-step phase-1">
                <div class="step-title">
                    <span class="step-number">2</span>Click "Show Turn Info" (Optional)
                </div>
                <div class="step-description">
                    Displays current turn state information for verification
                </div>
                <div class="step-expected">
                    ‚ÑπÔ∏è Blue info message with current player, turn number, and spin status
                </div>
            </div>
            
            <div class="phase-header">Phase 2: Core Turn Management Tests</div>
            
            <div class="instruction-step phase-2">
                <div class="step-title">
                    <span class="step-number">3</span>Click "Test Current Player Spin"
                </div>
                <div class="step-description">
                    Tests that the current player (player1) can successfully spin
                </div>
                <div class="step-expected">
                    ‚úÖ Success message, UI updates to waiting state
                </div>
            </div>
            
            <div class="instruction-step phase-2">
                <div class="step-title">
                    <span class="step-number">4</span>Click "Test Wrong Player Spin"
                </div>
                <div class="step-description">
                    Tests that non-current players cannot spin out of turn
                </div>
                <div class="step-expected">
                    ‚úÖ Success message confirming wrong player prevented from acting
                </div>
            </div>
            
            <div class="instruction-step phase-2">
                <div class="step-title">
                    <span class="step-number">5</span>Click "Test Double Spin Prevention"
                </div>
                <div class="step-description">
                    Tests that current player cannot spin twice in same turn
                </div>
                <div class="step-expected">
                    ‚úÖ Success message confirming double spin prevented
                </div>
            </div>
            
            <div class="instruction-step phase-2">
                <div class="step-title">
                    <span class="step-number">6</span>Click "Test Turn Advancement"
                </div>
                <div class="step-description">
                    Advances to the next player's turn
                </div>
                <div class="step-expected">
                    ‚úÖ Success message showing turn advanced, UI updates to next player
                </div>
            </div>
            
            <div class="phase-header">Phase 3: UI and Visual Tests</div>
            
            <div class="instruction-step phase-3">
                <div class="step-title">
                    <span class="step-number">7</span>Click "Test UI Turn Indicators"
                </div>
                <div class="step-description">
                    Verifies that UI elements properly display turn information
                </div>
                <div class="step-expected">
                    ‚úÖ Multiple success messages confirming UI visibility and content
                </div>
            </div>
            
            <div class="instruction-step phase-3">
                <div class="step-title">
                    <span class="step-number">8</span>Click "Test Wheel Button State"
                </div>
                <div class="step-description">
                    Mock test for wheel button states (placeholder implementation)
                </div>
                <div class="step-expected">
                    ‚úÖ Success message (mock), info about real implementation
                </div>
            </div>
            
            <div class="phase-header">Phase 4: Additional Testing</div>
            
            <div class="instruction-step phase-4">
                <div class="step-title">
                    <span class="step-number">‚Üª</span>Repeat Steps 3-6 for Multiple Cycles
                </div>
                <div class="step-description">
                    Test multiple turn cycles: player2 ‚Üí player3 ‚Üí player1 (turn 2)
                </div>
                <div class="step-expected">
                    üîÑ Continuous turn advancement and proper state management
                </div>
            </div>
            
            <div class="instruction-step phase-4">
                <div class="step-title">
                    <span class="step-number">üîÑ</span>Click "Reset Test" When Finished
                </div>
                <div class="step-description">
                    Clears all test results and hides turn management UI
                </div>
                <div class="step-expected">
                    üßπ Clean slate ready for fresh testing
                </div>
            </div>
            
            <div style="margin-top: 30px; padding: 15px; background: #e9ecef; border-radius: 5px;">
                <h4>üéØ What to Watch For:</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong style="color: #28a745;">Green (‚úì):</strong> Successful tests</li>
                    <li><strong style="color: #dc3545;">Red (‚úó):</strong> Failed tests or errors</li>
                    <li><strong style="color: #17a2b8;">Blue (‚ÑπÔ∏è):</strong> Informational feedback</li>
                    <li><strong>Turn UI:</strong> Updates with each turn change</li>
                    <li><strong>Timestamps:</strong> Track test progression</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Results Bar -->
    <div id="test-results">
        <h4>üîç Test Results (Live Updates)</h4>
        <div id="results-content">Click "Initialize Test Session" to begin testing.</div>
    </div>

    <script type="module">
        // Mock implementations for testing
        class MockGameManager {
            constructor() {
                this.currentTurn = {};
                this.turnOrder = {};
                this.players = {};
            }
            
            initializeTurnOrder(sessionId, playerIds) {
                this.turnOrder[sessionId] = [...playerIds];
                this.currentTurn[sessionId] = {
                    currentPlayerIndex: 0,
                    turnNumber: 1,
                    currentPlayerId: playerIds[0],
                    hasSpun: false
                };
                return true;
            }
            
            getCurrentPlayer(sessionId) {
                const turn = this.currentTurn[sessionId];
                return turn ? turn.currentPlayerId : null;
            }
            
            canPlayerAct(sessionId, playerId) {
                const turn = this.currentTurn[sessionId];
                if (!turn) return false;
                return turn.currentPlayerId === playerId && !turn.hasSpun;
            }
            
            recordPlayerSpin(sessionId, playerId) {
                const turn = this.currentTurn[sessionId];
                if (!turn || turn.currentPlayerId !== playerId || turn.hasSpun) {
                    return false;
                }
                turn.hasSpun = true;
                return true;
            }
            
            nextTurn(sessionId) {
                const turn = this.currentTurn[sessionId];
                const order = this.turnOrder[sessionId];
                
                if (!turn || !order) return null;
                
                turn.currentPlayerIndex = (turn.currentPlayerIndex + 1) % order.length;
                turn.currentPlayerId = order[turn.currentPlayerIndex];
                turn.hasSpun = false;
                
                if (turn.currentPlayerIndex === 0) {
                    turn.turnNumber++;
                }
                
                return turn.currentPlayerId;
            }
            
            getTurnInfo(sessionId) {
                return this.currentTurn[sessionId] || null;
            }
        }
        
        // Initialize mock game manager
        window.gameManager = new MockGameManager();
        window.currentSessionId = "test-session-123";
        
        // Mock current user
        window.getCurrentUser = () => ({ uid: "player1", displayName: "Test Player 1" });
        
        // Test data
        const testPlayers = ["player1", "player2", "player3"];
        let testResults = [];
        
        function logResult(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            testResults.push(`${icon} [${timestamp}] ${message}`);
            updateResultsDisplay();
            
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            console.log(`%c${message}`, `color: ${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}`);
        }
        
        function updateResultsDisplay() {
            const resultsContent = document.getElementById('results-content');
            if (resultsContent) {
                resultsContent.innerHTML = testResults.slice(-10).map(result => `<div>${result}</div>`).join('');
                resultsContent.scrollTop = resultsContent.scrollHeight;
            }
        }
        
        function updateTurnUI(sessionId) {
            const turnInfo = window.gameManager.getTurnInfo(sessionId);
            const currentUser = window.getCurrentUser();
            
            if (!turnInfo || !currentUser) return;
            
            // Show turn management section
            const turnManagement = document.getElementById('turn-management');
            if (turnManagement) {
                turnManagement.style.display = 'block';
            }
            
            // Update current player name
            const currentPlayerName = document.getElementById('current-player-name');
            const currentPlayerId = turnInfo.currentPlayerId;
            const displayName = currentPlayerId === currentUser.uid ? 'You' : `Player ${currentPlayerId.slice(-1)}`;
            
            if (currentPlayerName) {
                currentPlayerName.textContent = displayName;
            }
            
            // Update turn number
            const turnNumberSpan = document.getElementById('current-turn-number');
            if (turnNumberSpan) {
                turnNumberSpan.textContent = turnInfo.turnNumber;
            }
            
            // Update action messages
            const waitingMessage = document.getElementById('waiting-message');
            const yourTurnMessage = document.getElementById('your-turn-message');
            const waitingPlayerName = document.getElementById('waiting-player-name');
            
            const isCurrentPlayer = currentPlayerId === currentUser.uid;
            const hasSpun = turnInfo.hasSpun;
            
            if (isCurrentPlayer && !hasSpun) {
                if (waitingMessage) waitingMessage.style.display = 'none';
                if (yourTurnMessage) yourTurnMessage.style.display = 'block';
            } else {
                if (yourTurnMessage) yourTurnMessage.style.display = 'none';
                if (waitingMessage) {
                    waitingMessage.style.display = 'block';
                    if (waitingPlayerName) {
                        waitingPlayerName.textContent = isCurrentPlayer ? 'you to finish your turn' : displayName;
                    }
                }
            }
        }
        
        // Test functions
        window.initializeTest = function() {
            testResults = [];
            logResult("Initializing test session...", 'info');
            
            try {
                const success = window.gameManager.initializeTurnOrder(window.currentSessionId, testPlayers);
                if (success) {
                    updateTurnUI(window.currentSessionId);
                    logResult("Test session initialized successfully", 'success');
                    logResult(`Turn order: ${testPlayers.join(' ‚Üí ')}`, 'success');
                    logResult(`Current player: ${window.gameManager.getCurrentPlayer(window.currentSessionId)}`, 'success');
                } else {
                    logResult("Failed to initialize test session", 'error');
                }
            } catch (error) {
                logResult(`Error initializing test: ${error.message}`, 'error');
            }
        };
        
        window.showTurnInfo = function() {
            const turnInfo = window.gameManager.getTurnInfo(window.currentSessionId);
            if (turnInfo) {
                logResult(`Turn Info - Player: ${turnInfo.currentPlayerId}, Turn: ${turnInfo.turnNumber}, Has Spun: ${turnInfo.hasSpun}`, 'info');
            } else {
                logResult("No turn info available", 'error');
            }
        };
        
        window.resetTest = function() {
            testResults = [];
            const turnManagement = document.getElementById('turn-management');
            if (turnManagement) {
                turnManagement.style.display = 'none';
            }
            logResult("Test reset", 'info');
        };
        
        window.testCurrentPlayerSpin = function() {
            const currentPlayer = window.gameManager.getCurrentPlayer(window.currentSessionId);
            if (!currentPlayer) {
                logResult("No current player found", 'error');
                return;
            }
            
            const canAct = window.gameManager.canPlayerAct(window.currentSessionId, currentPlayer);
            if (canAct) {
                const spinRecorded = window.gameManager.recordPlayerSpin(window.currentSessionId, currentPlayer);
                if (spinRecorded) {
                    updateTurnUI(window.currentSessionId);
                    logResult(`Current player (${currentPlayer}) spin successful`, 'success');
                } else {
                    logResult(`Failed to record spin for current player (${currentPlayer})`, 'error');
                }
            } else {
                logResult(`Current player (${currentPlayer}) cannot act`, 'error');
            }
        };
        
        window.testWrongPlayerSpin = function() {
            const currentPlayer = window.gameManager.getCurrentPlayer(window.currentSessionId);
            const wrongPlayer = testPlayers.find(p => p !== currentPlayer);
            
            if (!wrongPlayer) {
                logResult("Could not find wrong player for test", 'error');
                return;
            }
            
            const canAct = window.gameManager.canPlayerAct(window.currentSessionId, wrongPlayer);
            if (!canAct) {
                logResult(`Wrong player (${wrongPlayer}) correctly prevented from acting`, 'success');
            } else {
                logResult(`Wrong player (${wrongPlayer}) was allowed to act (should be prevented)`, 'error');
            }
        };
        
        window.testDoubleSpinPrevention = function() {
            const currentPlayer = window.gameManager.getCurrentPlayer(window.currentSessionId);
            const turnInfo = window.gameManager.getTurnInfo(window.currentSessionId);
            
            if (!turnInfo.hasSpun) {
                logResult("Player hasn't spun yet, spinning first...", 'info');
                window.gameManager.recordPlayerSpin(window.currentSessionId, currentPlayer);
            }
            
            const canActAgain = window.gameManager.canPlayerAct(window.currentSessionId, currentPlayer);
            if (!canActAgain) {
                logResult(`Double spin correctly prevented for player (${currentPlayer})`, 'success');
            } else {
                logResult(`Double spin was allowed (should be prevented)`, 'error');
            }
        };
        
        window.testTurnAdvancement = function() {
            const currentPlayer = window.gameManager.getCurrentPlayer(window.currentSessionId);
            const currentTurn = window.gameManager.getTurnInfo(window.currentSessionId).turnNumber;
            
            const nextPlayer = window.gameManager.nextTurn(window.currentSessionId);
            const newTurn = window.gameManager.getTurnInfo(window.currentSessionId).turnNumber;
            
            if (nextPlayer && nextPlayer !== currentPlayer) {
                updateTurnUI(window.currentSessionId);
                logResult(`Turn advanced from ${currentPlayer} to ${nextPlayer}`, 'success');
                if (newTurn > currentTurn) {
                    logResult(`Turn number advanced from ${currentTurn} to ${newTurn}`, 'success');
                }
            } else {
                logResult(`Turn advancement failed`, 'error');
            }
        };
        
        window.testUIUpdates = function() {
            updateTurnUI(window.currentSessionId);
            
            const turnManagement = document.getElementById('turn-management');
            const currentPlayerName = document.getElementById('current-player-name');
            const turnNumber = document.getElementById('current-turn-number');
            
            if (turnManagement && turnManagement.style.display !== 'none') {
                logResult("Turn management UI is visible", 'success');
            } else {
                logResult("Turn management UI is not visible", 'error');
            }
            
            if (currentPlayerName && currentPlayerName.textContent) {
                logResult(`Current player name displayed: ${currentPlayerName.textContent}`, 'success');
            } else {
                logResult("Current player name not displayed", 'error');
            }
            
            if (turnNumber && turnNumber.textContent) {
                logResult(`Turn number displayed: ${turnNumber.textContent}`, 'success');
            } else {
                logResult("Turn number not displayed", 'error');
            }
        };
        
        window.testWheelButtonState = function() {
            // This would test the actual wheel button state in a real implementation
            logResult("Wheel button state test (mock implementation)", 'success');
            logResult("In real implementation, this would test button enable/disable states", 'info');
        };
        
        window.runAllTests = function() {
            logResult('üöÄ Running all turn management tests...', 'info');
            testResults = [];
            
            const tests = [
                () => { logResult('=== Starting automated test sequence ===', 'info'); },
                initializeTest,
                () => { setTimeout(() => testCurrentPlayerSpin(), 500); },
                () => { setTimeout(() => testWrongPlayerSpin(), 1000); },
                () => { setTimeout(() => testDoubleSpinPrevention(), 1500); },
                () => { setTimeout(() => testTurnAdvancement(), 2000); },
                () => { setTimeout(() => testUIUpdates(), 2500); },
                () => { setTimeout(() => testWheelButtonState(), 3000); },
                () => { setTimeout(() => logResult('üèÅ All turn management tests completed', 'success'), 3500); }
            ];
            
            tests.forEach((test, index) => {
                setTimeout(() => {
                    try {
                        test();
                    } catch (error) {
                        logResult(`‚ùå Test ${index + 1} failed: ${error.message}`, 'error');
                    }
                }, index * 100);
            });
        };
    </script>

<script>
window.testCompletionSignal = {
    completed: false,
    timestamp: null,
    results: null
};

function markTestComplete(results = null) {
    window.testCompletionSignal.completed = true;
    window.testCompletionSignal.timestamp = new Date().toISOString();
    window.testCompletionSignal.results = results;
    console.log('TEST_COMPLETION_SIGNAL:', JSON.stringify(window.testCompletionSignal));
    
    document.body.style.border = '5px solid #28a745';
    document.body.style.backgroundColor = '#f8fff8';
    
    const banner = document.createElement('div');
    banner.innerHTML = '‚úÖ TEST COMPLETED - Ready for next test';
    banner.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0;
        background: #28a745; color: white; padding: 15px;
        text-align: center; font-weight: bold; z-index: 9999;
    `;
    document.body.appendChild(banner);
}

const completionButton = document.createElement('button');
completionButton.innerHTML = 'üèÅ Mark Test Complete';
completionButton.style.cssText = `
    position: fixed; bottom: 20px; right: 20px;
    background: #28a745; color: white; border: none;
    padding: 15px 25px; border-radius: 5px;
    font-size: 16px; font-weight: bold; cursor: pointer; z-index: 9999;
`;
completionButton.onclick = () => markTestComplete();
document.body.appendChild(completionButton);
</script>
</body>
</html>